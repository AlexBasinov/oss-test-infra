prow_ignored:
- &config-sync-e2e-job
  cluster: build-kpt-config-sync
  skip_branches:
  - ^v1\.13$
  always_run: false
  skip_if_only_changed: "^(docs|dashboard)/|\\.md$|^(LICENSE|OWNERS)$"
  # Ensure that we don't try to schedule more than 5 jobs at a time. This means
  # we won't automatically get "Pods Unschedulable", but Prow will wait patiently
  # for other jobs to complete before running.
  max_concurrency: 4
  decorate: true
  labels:
    # We think this label is required to use kind. Copied from presubmit job above.
    preset-kind-volume-mounts: "true"
    # These labels are on the other jobs, so they're here.
    preset-service-account: "true"
    # Enable docker-in-docker, and use memory for etcd instead of disk-backed.
    preset-dind-enabled-memory: "true"
  decoration_config:
    # Tests usually finish in ~15 minutes, but this ensures we don't fail on the
    # odd test that takes much longer than normal.
    timeout: 60m
  spec: &config-sync-e2e-job-spec
    containers:
    # Use the special version of the kubekins 1.22 image with Kind
    # v0.14.0 installed.
    - &config-sync-e2e-container
      image: gcr.io/oss-prow-build-kpt-config-sync/e2e-prow:kubekins-e2e-v20220708-6b0cfd300e-1.23-kind-v0.14.0
      command:
      - runner.sh
      env:
      # This is only used to tell the job where to store the images.
      # It can be any non-empty value that is a valid gcr.io folder name.
      - name: USER
        value: "kpt-config-sync-e2e-go-ci"
      # TODO: unset GCP_PROJECT once jobs can rely on resources in oss prow project
      - name: GCP_PROJECT
        value: "stolos-dev"
      securityContext:
        privileged: true
      resources:
        requests:
          memory: "50Gi"
          # This value is experimentally determined.
          # We know to increase this when CPU usage is reported as above 1.0
          # and we observe randomly flaky tests. Check the nodes in our Prow CI
          # cluster.
          cpu: "26000m"
    nodeSelector:
      kpt-config-sync/type: presubmit
      kpt-config-sync/size: large


presubmits:
  GoogleContainerTools/kpt-config-sync:
  - name: kpt-config-sync-presubmit
    cluster: build-kpt-config-sync
#    branches: ["master"]
    always_run: true
    decorate: true
    labels:
      preset-dind-enabled: "true"
    spec:
      containers:
      - image: gcr.io/k8s-staging-test-infra/kubekins-e2e:v20220708-6b0cfd300e-1.23
        command:
        - runner.sh
        args:
        - make
        - test-presubmit
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "2Gi"
            cpu: "2000m"
      nodeSelector:
        # This job requires 8vCPUs or less, so it is "small".
        cloud.google.com/gke-nodepool: small-job-pool
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-mono-repo-test-group1
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-kind-mono-repo-test-group1
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-mono-repo-test-group2
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-kind-mono-repo-test-group2
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-mono-repo-test-group3
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-kind-mono-repo-test-group3
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-multi-repo-test-group1
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-kind-multi-repo-test-group1
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-multi-repo-test-group2
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-kind-multi-repo-test-group2
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-multi-repo-test-group3
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-kind-multi-repo-test-group3
  # TODO: remove this job once cherry picks are done for v1.13
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-multi-repo
    branches:
    - ^v1\.13$
    skip_branches: []
    max_concurrency: 2
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-go-ephemeral-multi-repo
        resources:
          requests:
            memory: "100Gi"
            cpu: "54000m"
      nodeSelector:
        cloud.google.com/gke-nodepool: large-job-pool-v113
  # TODO: remove this job once cherry picks are done for v1.13
  - <<: *config-sync-e2e-job
    name: kpt-config-sync-presubmit-e2e-mono-repo
    branches:
    - ^v1\.13$
    skip_branches: []
    max_concurrency: 2
    spec:
      <<: *config-sync-e2e-job-spec
      containers:
      - <<: *config-sync-e2e-container
        args:
        - make
        - test-e2e-go-ephemeral-mono-repo
        resources:
          requests:
            memory: "100Gi"
            cpu: "54000m"
      nodeSelector:
        cloud.google.com/gke-nodepool: large-job-pool-v113
